(window.webpackJsonp=window.webpackJsonp||[]).push([[33],{183:function(t,_,v){"use strict";v.r(_);var l={computed:{data:function(){return{title:"[译] 浏览器中的 ES6 module 实现",description:"浏览器中的 ES6 module 实现",keywords:"翻译,ES6",pathname:"es-modules-in-browsers",translation:{author:"@Jake Archibald",social:"https://jakearchibald.com/",from:"https://jakearchibald.com/2017/es-modules-in-browsers/"},create_time:"2017-05-06",prev:{title:"Chrome 中的 “Tab to Search” 与 Open Search",pathname:"opensearch"},next:{title:"Facebook 开源代码优化工具 Prepack",pathname:"prepack"}}}}},n=v(3),component=Object(n.a)(l,function(){var t=this,_=t.$createElement,v=t._self._c||_;return v("post",{attrs:{data:t.data}},[v("p",[t._v("ES6 的模块特性（module） 开始在浏览器端实现啦！一切正在路上...")]),t._v(" "),v("table",[v("thead",[v("tr",[v("th",[t._v("浏览器")]),t._v(" "),v("th",[t._v("备注")])])]),t._v(" "),v("tbody",[v("tr",[v("td",[t._v("Safari 10.1")]),t._v(" "),v("td",[t._v("(无)")])]),t._v(" "),v("tr",[v("td",[t._v("Chrome Canary 60")]),t._v(" "),v("td",[t._v("打开 "),v("code",[t._v("chrome:flags")]),t._v(" 启用“实验性网络平台功能”")])]),t._v(" "),v("tr",[v("td",[t._v("Firefox 54")]),t._v(" "),v("td",[t._v("打开 "),v("code",[t._v("about:config")]),t._v(" 启用 "),v("code",[t._v("dom.moduleScripts.enabled")])])]),t._v(" "),v("tr",[v("td",[t._v("Edge 15")]),t._v(" "),v("td",[t._v("打开 "),v("code",[t._v("about:flags")]),t._v(" 启用“实验性 JavaScript 功能”")])])])]),t._v(" "),v("pre",[v("code",{staticClass:"hljs lang-html"},[v("span",{staticClass:"hljs-tag"},[t._v("<"),v("span",{staticClass:"hljs-name"},[t._v("script")]),t._v(" "),v("span",{staticClass:"hljs-attr"},[t._v("type")]),t._v("="),v("span",{staticClass:"hljs-string"},[t._v('"module"')]),t._v(">")]),v("span",{staticClass:"javascript"},[t._v("\n  "),v("span",{staticClass:"hljs-keyword"},[t._v("import")]),t._v(" {addTextToBody} "),v("span",{staticClass:"hljs-keyword"},[t._v("from")]),t._v(" "),v("span",{staticClass:"hljs-string"},[t._v("'./utils.js'")]),t._v(";\n\n  addTextToBody("),v("span",{staticClass:"hljs-string"},[t._v("'Modules are pretty cool.'")]),t._v(");\n")]),v("span",{staticClass:"hljs-tag"},[t._v("</"),v("span",{staticClass:"hljs-name"},[t._v("script")]),t._v(">")])])]),v("pre",[v("code",{staticClass:"hljs lang-javascript"},[v("span",{staticClass:"hljs-comment"},[t._v("// utils.js")]),t._v("\n"),v("span",{staticClass:"hljs-keyword"},[t._v("export")]),t._v(" "),v("span",{staticClass:"hljs-function"},[v("span",{staticClass:"hljs-keyword"},[t._v("function")]),t._v(" "),v("span",{staticClass:"hljs-title"},[t._v("addTextToBody")]),t._v("("),v("span",{staticClass:"hljs-params"},[t._v("text")]),t._v(") ")]),t._v("{\n  "),v("span",{staticClass:"hljs-keyword"},[t._v("const")]),t._v(" div = "),v("span",{staticClass:"hljs-built_in"},[t._v("document")]),t._v(".createElement("),v("span",{staticClass:"hljs-string"},[t._v("'div'")]),t._v(");\n  div.textContent = text;\n  "),v("span",{staticClass:"hljs-built_in"},[t._v("document")]),t._v(".body.appendChild(div);\n}")])]),v("p",[v("strong",[v("a",{attrs:{href:"https://cdn.rawgit.com/jakearchibald/a298d5af601982c338186cd355e624a8/raw/aaa2cbee9a5810d14b01ae965e52ecb9b2965a44/",target:"_blank"}},[t._v("Live demo")])]),t._v("。")]),t._v(" "),v("p",[t._v("只需为 "),v("code",[t._v("script")]),t._v(" 元素添加 "),v("code",[t._v("type=module")]),t._v(" 属性，浏览器就会把该元素对应的内联脚本或外部脚本当成 ECMAScript 模块进行处理。")]),t._v(" "),v("p",[t._v("目前已经有一些 "),v("a",{attrs:{href:"https://ponyfoo.com/articles/es6-modules-in-depth",target:"_blank"}},[t._v("很棒的关于 ECMAScript 模块的文章")]),t._v("了，不过我还是想分享一些和浏览器相关的东西，它们都是我在测试代码、阅读规范的过程中学习到的。")]),t._v(" "),v("h2",{attrs:{id:"-import-"}},[t._v("尚未得到支持的 import 路径符号")]),t._v(" "),v("pre",[v("code",{staticClass:"hljs lang-javascript"},[v("span",{staticClass:"hljs-comment"},[t._v("// 支持")]),t._v("\n"),v("span",{staticClass:"hljs-keyword"},[t._v("import")]),t._v(" {foo} "),v("span",{staticClass:"hljs-keyword"},[t._v("from")]),t._v(" "),v("span",{staticClass:"hljs-string"},[t._v("'https://jakearchibald.com/utils/bar.js'")]),t._v(";\n"),v("span",{staticClass:"hljs-keyword"},[t._v("import")]),t._v(" {foo} "),v("span",{staticClass:"hljs-keyword"},[t._v("from")]),t._v(" "),v("span",{staticClass:"hljs-string"},[t._v("'/utils/bar.js'")]),t._v(";\n"),v("span",{staticClass:"hljs-keyword"},[t._v("import")]),t._v(" {foo} "),v("span",{staticClass:"hljs-keyword"},[t._v("from")]),t._v(" "),v("span",{staticClass:"hljs-string"},[t._v("'./bar.js'")]),t._v(";\n"),v("span",{staticClass:"hljs-keyword"},[t._v("import")]),t._v(" {foo} "),v("span",{staticClass:"hljs-keyword"},[t._v("from")]),t._v(" "),v("span",{staticClass:"hljs-string"},[t._v("'../bar.js'")]),t._v(";\n\n"),v("span",{staticClass:"hljs-comment"},[t._v("// 不支持")]),t._v("\n"),v("span",{staticClass:"hljs-keyword"},[t._v("import")]),t._v(" {foo} "),v("span",{staticClass:"hljs-keyword"},[t._v("from")]),t._v(" "),v("span",{staticClass:"hljs-string"},[t._v("'bar.js'")]),t._v(";\n"),v("span",{staticClass:"hljs-keyword"},[t._v("import")]),t._v(" {foo} "),v("span",{staticClass:"hljs-keyword"},[t._v("from")]),t._v(" "),v("span",{staticClass:"hljs-string"},[t._v("'utils/bar.js'")]),t._v(";")])]),v("p",[t._v("有效的路径符号应当符合以下条件规则之一：")]),t._v(" "),v("ul",[v("li",[t._v("完整的非相对路径。这样在将其传给"),v("code",[t._v("new URL(moduleSpecifier)")]),t._v("的时候才不会报错。")]),t._v(" "),v("li",[t._v("以 "),v("code",[t._v("/")]),t._v(" 开头。")]),t._v(" "),v("li",[t._v("以 "),v("code",[t._v("./")]),t._v(" 开头。")]),t._v(" "),v("li",[t._v("以 "),v("code",[t._v("../")]),t._v(" 开头。")])]),t._v(" "),v("p",[t._v("其他形式的符号被保留下来，未来将用于其他功能（如引入[import]内置模块）。")]),t._v(" "),v("h2",{attrs:{id:"-nomodule-"}},[t._v("使用 "),v("code",[t._v("nomodule")]),t._v(" 属性向后兼容")]),t._v(" "),v("pre",[v("code",{staticClass:"hljs lang-html"},[v("span",{staticClass:"hljs-tag"},[t._v("<"),v("span",{staticClass:"hljs-name"},[t._v("script")]),t._v(" "),v("span",{staticClass:"hljs-attr"},[t._v("type")]),t._v("="),v("span",{staticClass:"hljs-string"},[t._v('"module"')]),t._v(" "),v("span",{staticClass:"hljs-attr"},[t._v("src")]),t._v("="),v("span",{staticClass:"hljs-string"},[t._v('"module.js"')]),t._v(">")]),v("span",{staticClass:"undefined"}),v("span",{staticClass:"hljs-tag"},[t._v("</"),v("span",{staticClass:"hljs-name"},[t._v("script")]),t._v(">")]),t._v("\n"),v("span",{staticClass:"hljs-tag"},[t._v("<"),v("span",{staticClass:"hljs-name"},[t._v("script")]),t._v(" "),v("span",{staticClass:"hljs-attr"},[t._v("nomodule")]),t._v(" "),v("span",{staticClass:"hljs-attr"},[t._v("src")]),t._v("="),v("span",{staticClass:"hljs-string"},[t._v('"fallback.js"')]),t._v(">")]),v("span",{staticClass:"undefined"}),v("span",{staticClass:"hljs-tag"},[t._v("</"),v("span",{staticClass:"hljs-name"},[t._v("script")]),t._v(">")])])]),v("p",[v("strong",[v("a",{attrs:{href:"https://cdn.rawgit.com/jakearchibald/6110fb6df717ebca44c2e40814cc12af/raw/7fc79ed89199c2512a4579c9a3ba19f72c219bd8/",target:"_blank"}},[t._v("Live demo")])]),t._v("。")]),t._v(" "),v("p",[t._v("支持 "),v("code",[t._v("type=module")]),t._v(" 的浏览器将会忽略带有 "),v("code",[t._v("nomodule")]),t._v(" 属性的 "),v("code",[t._v("script")]),t._v(" 标签。这意味着我们可以为支持模块的浏览器提供模块形式的代码，同时为那些不支持模块的浏览器提供降级处理。")]),t._v(" "),v("h3",{attrs:{id:"-issue"}},[t._v("浏览器 issue")]),t._v(" "),v("ul",[v("li",[t._v("Firefox 暂不支持 "),v("code",[t._v("nomodule")]),t._v(" ("),v("a",{attrs:{href:"https://bugzilla.mozilla.org/show_bug.cgi?id=1330900",target:"_blank"}},[t._v("issue")]),t._v(")。")]),t._v(" "),v("li",[t._v("Edge 暂不支持 "),v("code",[t._v("nomodule")]),t._v(" ("),v("a",{attrs:{href:"https://developer.microsoft.com/en-us/microsoft-edge/platform/issues/10525830/",target:"_blank"}},[t._v("issue")]),t._v(")。")]),t._v(" "),v("li",[t._v("Safari 10.1 暂不支持 "),v("code",[t._v("nomodule")]),t._v("，但在最新的技术预览版中已经解决了此问题。对于 10.1 来说，有一个"),v("a",{attrs:{href:"https://gist.github.com/samthor/64b114e4a4f539915a95b91ffd340acc",target:"_blank"}},[t._v("相当棒的解决方案")]),t._v("。")])]),t._v(" "),v("h2",{attrs:{id:"-"}},[t._v("默认延迟执行")]),t._v(" "),v("pre",[v("code",{staticClass:"hljs lang-html"},[v("span",{staticClass:"hljs-comment"},[t._v("\x3c!-- 这个脚本会在… --\x3e")]),t._v("\n"),v("span",{staticClass:"hljs-tag"},[t._v("<"),v("span",{staticClass:"hljs-name"},[t._v("script")]),t._v(" "),v("span",{staticClass:"hljs-attr"},[t._v("type")]),t._v("="),v("span",{staticClass:"hljs-string"},[t._v('"module"')]),t._v(" "),v("span",{staticClass:"hljs-attr"},[t._v("src")]),t._v("="),v("span",{staticClass:"hljs-string"},[t._v('"1.js"')]),t._v(">")]),v("span",{staticClass:"undefined"}),v("span",{staticClass:"hljs-tag"},[t._v("</"),v("span",{staticClass:"hljs-name"},[t._v("script")]),t._v(">")]),t._v("\n\n"),v("span",{staticClass:"hljs-comment"},[t._v("\x3c!-- …这个脚本之后、… --\x3e")]),t._v("\n"),v("span",{staticClass:"hljs-tag"},[t._v("<"),v("span",{staticClass:"hljs-name"},[t._v("script")]),t._v(" "),v("span",{staticClass:"hljs-attr"},[t._v("src")]),t._v("="),v("span",{staticClass:"hljs-string"},[t._v('"2.js"')]),t._v(">")]),v("span",{staticClass:"undefined"}),v("span",{staticClass:"hljs-tag"},[t._v("</"),v("span",{staticClass:"hljs-name"},[t._v("script")]),t._v(">")]),t._v("\n\n"),v("span",{staticClass:"hljs-comment"},[t._v("\x3c!-- …这个脚本之前执行。 --\x3e")]),t._v("\n"),v("span",{staticClass:"hljs-tag"},[t._v("<"),v("span",{staticClass:"hljs-name"},[t._v("script")]),t._v(" "),v("span",{staticClass:"hljs-attr"},[t._v("defer")]),t._v(" "),v("span",{staticClass:"hljs-attr"},[t._v("src")]),t._v("="),v("span",{staticClass:"hljs-string"},[t._v('"3.js"')]),t._v(">")]),v("span",{staticClass:"undefined"}),v("span",{staticClass:"hljs-tag"},[t._v("</"),v("span",{staticClass:"hljs-name"},[t._v("script")]),t._v(">")])])]),v("p",[v("strong",[v("a",{attrs:{href:"https://cdn.rawgit.com/jakearchibald/d6808ea2665f8b3994380160dc2c0bc1/raw/c0a194aa70dda1339c960c6f05b2e16988ee66ac/",target:"_blank"}},[t._v("Live demo")])]),t._v("。脚本执行顺序为 "),v("code",[t._v("2.js")]),t._v(", "),v("code",[t._v("1.js")]),t._v(", "),v("code",[t._v("3.js")]),t._v("。")]),t._v(" "),v("p",[t._v("获取脚本会导致 HTML parser 阻塞，这简直太太太太恶心了。对正常的脚本，我们可以使用 "),v("code",[t._v("defer")]),t._v(" 属性来防止阻塞，脚本将延迟至文档解析完毕后执行，同时保持与其他使用 "),v("code",[t._v("defer")]),t._v(" 的脚本之间的执行顺序。模块脚本的默认行为与 "),v("code",[t._v("defer")]),t._v(" 相同 —— 无法使模块脚本阻塞 HTML parser。")]),t._v(" "),v("p",[t._v("模块脚本与使用 "),v("code",[t._v("defer")]),t._v(" 的正常脚本使用相同的执行队列。")]),t._v(" "),v("h2",{attrs:{id:"-"}},[t._v("内联脚本同样延迟")]),t._v(" "),v("pre",[v("code",{staticClass:"hljs lang-html"},[v("span",{staticClass:"hljs-comment"},[t._v("\x3c!-- 这个脚本会在… --\x3e")]),t._v("\n"),v("span",{staticClass:"hljs-tag"},[t._v("<"),v("span",{staticClass:"hljs-name"},[t._v("script")]),t._v(" "),v("span",{staticClass:"hljs-attr"},[t._v("type")]),t._v("="),v("span",{staticClass:"hljs-string"},[t._v('"module"')]),t._v(">")]),v("span",{staticClass:"actionscript"},[t._v("\n  addTextToBody("),v("span",{staticClass:"hljs-string"},[t._v('"Inline module executed"')]),t._v(");\n")]),v("span",{staticClass:"hljs-tag"},[t._v("</"),v("span",{staticClass:"hljs-name"},[t._v("script")]),t._v(">")]),t._v("\n\n"),v("span",{staticClass:"hljs-comment"},[t._v("\x3c!-- …这个脚本… --\x3e")]),t._v("\n"),v("span",{staticClass:"hljs-tag"},[t._v("<"),v("span",{staticClass:"hljs-name"},[t._v("script")]),t._v(" "),v("span",{staticClass:"hljs-attr"},[t._v("src")]),t._v("="),v("span",{staticClass:"hljs-string"},[t._v('"1.js"')]),t._v(">")]),v("span",{staticClass:"undefined"}),v("span",{staticClass:"hljs-tag"},[t._v("</"),v("span",{staticClass:"hljs-name"},[t._v("script")]),t._v(">")]),t._v("\n\n"),v("span",{staticClass:"hljs-comment"},[t._v("\x3c!-- …以及这个脚本之后、… --\x3e")]),t._v("\n"),v("span",{staticClass:"hljs-tag"},[t._v("<"),v("span",{staticClass:"hljs-name"},[t._v("script")]),t._v(" "),v("span",{staticClass:"hljs-attr"},[t._v("defer")]),t._v(">")]),v("span",{staticClass:"actionscript"},[t._v("\n  addTextToBody("),v("span",{staticClass:"hljs-string"},[t._v('"Inline script executed"')]),t._v(");\n")]),v("span",{staticClass:"hljs-tag"},[t._v("</"),v("span",{staticClass:"hljs-name"},[t._v("script")]),t._v(">")]),t._v("\n\n"),v("span",{staticClass:"hljs-comment"},[t._v("\x3c!-- …这个脚本之前执行。 --\x3e")]),t._v("\n"),v("span",{staticClass:"hljs-tag"},[t._v("<"),v("span",{staticClass:"hljs-name"},[t._v("script")]),t._v(" "),v("span",{staticClass:"hljs-attr"},[t._v("defer")]),t._v(" "),v("span",{staticClass:"hljs-attr"},[t._v("src")]),t._v("="),v("span",{staticClass:"hljs-string"},[t._v('"2.js"')]),t._v(">")]),v("span",{staticClass:"undefined"}),v("span",{staticClass:"hljs-tag"},[t._v("</"),v("span",{staticClass:"hljs-name"},[t._v("script")]),t._v(">")])])]),v("p",[v("strong",[v("a",{attrs:{href:"https://cdn.rawgit.com/jakearchibald/7026f72c0675898196f7669699e3231e/raw/fc7521aabd9485f30dbd5189b407313cd350cf2b/",target:"_blank"}},[t._v("Live demo")])]),t._v("。执行顺序依次为 "),v("code",[t._v("1.js")]),t._v("、内联脚本、内联模块、"),v("code",[t._v("2.js")]),t._v("。")]),t._v(" "),v("p",[t._v("正常的内联脚本会忽略 "),v("code",[t._v("defer")]),t._v(" 属性，而内联模块则总是延迟执行，无论是否引入其他内容。")]),t._v(" "),v("h2",{attrs:{id:"-async-"}},[v("code",[t._v("async")]),t._v(" 对内联、外部模块同样适用")]),t._v(" "),v("pre",[v("code",{staticClass:"hljs lang-html"},[v("span",{staticClass:"hljs-comment"},[t._v("\x3c!-- 脚本将会在其引入的模块加载完成后立即执行 --\x3e")]),t._v("\n"),v("span",{staticClass:"hljs-tag"},[t._v("<"),v("span",{staticClass:"hljs-name"},[t._v("script")]),t._v(" "),v("span",{staticClass:"hljs-attr"},[t._v("async")]),t._v(" "),v("span",{staticClass:"hljs-attr"},[t._v("type")]),t._v("="),v("span",{staticClass:"hljs-string"},[t._v('"module"')]),t._v(">")]),v("span",{staticClass:"javascript"},[t._v("\n  "),v("span",{staticClass:"hljs-keyword"},[t._v("import")]),t._v(" {addTextToBody} "),v("span",{staticClass:"hljs-keyword"},[t._v("from")]),t._v(" "),v("span",{staticClass:"hljs-string"},[t._v("'./utils.js'")]),t._v(";\n\n  addTextToBody("),v("span",{staticClass:"hljs-string"},[t._v("'Inline module executed.'")]),t._v(");\n")]),v("span",{staticClass:"hljs-tag"},[t._v("</"),v("span",{staticClass:"hljs-name"},[t._v("script")]),t._v(">")]),t._v("\n\n"),v("span",{staticClass:"hljs-comment"},[t._v("\x3c!-- 脚本及其引入的模块加载完成后立即执行 --\x3e")]),t._v("\n"),v("span",{staticClass:"hljs-tag"},[t._v("<"),v("span",{staticClass:"hljs-name"},[t._v("script")]),t._v(" "),v("span",{staticClass:"hljs-attr"},[t._v("async")]),t._v(" "),v("span",{staticClass:"hljs-attr"},[t._v("type")]),t._v("="),v("span",{staticClass:"hljs-string"},[t._v('"module"')]),t._v(" "),v("span",{staticClass:"hljs-attr"},[t._v("src")]),t._v("="),v("span",{staticClass:"hljs-string"},[t._v('"1.js"')]),t._v(">")]),v("span",{staticClass:"undefined"}),v("span",{staticClass:"hljs-tag"},[t._v("</"),v("span",{staticClass:"hljs-name"},[t._v("script")]),t._v(">")])])]),v("p",[v("strong",[v("a",{attrs:{href:"https://module-script-tests-rgjnxtrtqq.now.sh/async",target:"_blank"}},[t._v("Live demo")])]),t._v("。先完成加载的脚本先执行。")]),t._v(" "),v("p",[t._v("与正常脚本相同，带有 "),v("code",[t._v("async")]),t._v(" 属性的脚本在下载时不会阻塞 HTML parser，一旦加载完毕，立即执行。不同的是，"),v("code",[t._v("async")]),t._v(" 对内联模块也同样适用。")]),t._v(" "),v("p",[t._v("使用 "),v("code",[t._v("async")]),t._v(" 时，脚本的执行顺序可能会和它们在 DOM 中出现的顺序不尽相同。")]),t._v(" "),v("h3",{attrs:{id:"-issue"}},[t._v("浏览器 issue")]),t._v(" "),v("ul",[v("li",[t._v("Firefox 不支持内联模块使用 "),v("code",[t._v("async")]),t._v("("),v("a",{attrs:{href:"https://bugzilla.mozilla.org/show_bug.cgi?id=1361369",target:"_blank"}},[t._v("issue")]),t._v(")。")])]),t._v(" "),v("h2",{attrs:{id:"-"}},[t._v("模块只执行一次")]),t._v(" "),v("pre",[v("code",{staticClass:"hljs lang-html"},[v("span",{staticClass:"hljs-comment"},[t._v("\x3c!-- 1.js 只执行一次 --\x3e")]),t._v("\n"),v("span",{staticClass:"hljs-tag"},[t._v("<"),v("span",{staticClass:"hljs-name"},[t._v("script")]),t._v(" "),v("span",{staticClass:"hljs-attr"},[t._v("type")]),t._v("="),v("span",{staticClass:"hljs-string"},[t._v('"module"')]),t._v(" "),v("span",{staticClass:"hljs-attr"},[t._v("src")]),t._v("="),v("span",{staticClass:"hljs-string"},[t._v('"1.js"')]),t._v(">")]),v("span",{staticClass:"undefined"}),v("span",{staticClass:"hljs-tag"},[t._v("</"),v("span",{staticClass:"hljs-name"},[t._v("script")]),t._v(">")]),t._v("\n"),v("span",{staticClass:"hljs-tag"},[t._v("<"),v("span",{staticClass:"hljs-name"},[t._v("script")]),t._v(" "),v("span",{staticClass:"hljs-attr"},[t._v("type")]),t._v("="),v("span",{staticClass:"hljs-string"},[t._v('"module"')]),t._v(" "),v("span",{staticClass:"hljs-attr"},[t._v("src")]),t._v("="),v("span",{staticClass:"hljs-string"},[t._v('"1.js"')]),t._v(">")]),v("span",{staticClass:"undefined"}),v("span",{staticClass:"hljs-tag"},[t._v("</"),v("span",{staticClass:"hljs-name"},[t._v("script")]),t._v(">")]),t._v("\n"),v("span",{staticClass:"hljs-tag"},[t._v("<"),v("span",{staticClass:"hljs-name"},[t._v("script")]),t._v(" "),v("span",{staticClass:"hljs-attr"},[t._v("type")]),t._v("="),v("span",{staticClass:"hljs-string"},[t._v('"module"')]),t._v(">")]),v("span",{staticClass:"actionscript"},[t._v("\n  "),v("span",{staticClass:"hljs-meta"},[v("span",{staticClass:"hljs-meta-keyword"},[t._v("import")]),t._v(' "./1.js";')]),t._v("\n")]),v("span",{staticClass:"hljs-tag"},[t._v("</"),v("span",{staticClass:"hljs-name"},[t._v("script")]),t._v(">")]),t._v("\n\n"),v("span",{staticClass:"hljs-comment"},[t._v("\x3c!-- 普通脚本会执行多次 --\x3e")]),t._v("\n"),v("span",{staticClass:"hljs-tag"},[t._v("<"),v("span",{staticClass:"hljs-name"},[t._v("script")]),t._v(" "),v("span",{staticClass:"hljs-attr"},[t._v("src")]),t._v("="),v("span",{staticClass:"hljs-string"},[t._v('"2.js"')]),t._v(">")]),v("span",{staticClass:"undefined"}),v("span",{staticClass:"hljs-tag"},[t._v("</"),v("span",{staticClass:"hljs-name"},[t._v("script")]),t._v(">")]),t._v("\n"),v("span",{staticClass:"hljs-tag"},[t._v("<"),v("span",{staticClass:"hljs-name"},[t._v("script")]),t._v(" "),v("span",{staticClass:"hljs-attr"},[t._v("src")]),t._v("="),v("span",{staticClass:"hljs-string"},[t._v('"2.js"')]),t._v(">")]),v("span",{staticClass:"undefined"}),v("span",{staticClass:"hljs-tag"},[t._v("</"),v("span",{staticClass:"hljs-name"},[t._v("script")]),t._v(">")])])]),v("p",[v("strong",[v("a",{attrs:{href:"https://cdn.rawgit.com/jakearchibald/f7f6d37ef1b4d8a4f908f3e80d50f4fe/raw/1fcedde007a2b90049a7ea438781aebe69e22762/",target:"_blank"}},[t._v("Live demo")])]),t._v("。")]),t._v(" "),v("p",[t._v("引入同一个模块多次的时候，模块只会执行一次。这对 HTML 中的模块脚本同样适用 —— 在同一个页面中，URL 相同的模块只会执行一次。")]),t._v(" "),v("h3",{attrs:{id:"-issue"}},[t._v("浏览器 issue")]),t._v(" "),v("ul",[v("li",[t._v("Edge 会执行多次 ("),v("a",{attrs:{href:"https://developer.microsoft.com/en-us/microsoft-edge/platform/issues/11865922/",target:"_blank"}},[t._v("issue")]),t._v(")。")])]),t._v(" "),v("h2",{attrs:{id:"-cors"}},[t._v("总是使用 CORS")]),t._v(" "),v("pre",[v("code",{staticClass:"hljs lang-html"},[v("span",{staticClass:"hljs-comment"},[t._v("\x3c!-- 模块不会执行，因其未通过 CORS 检查 --\x3e")]),t._v("\n"),v("span",{staticClass:"hljs-tag"},[t._v("<"),v("span",{staticClass:"hljs-name"},[t._v("script")]),t._v(" "),v("span",{staticClass:"hljs-attr"},[t._v("type")]),t._v("="),v("span",{staticClass:"hljs-string"},[t._v('"module"')]),t._v(" "),v("span",{staticClass:"hljs-attr"},[t._v("src")]),t._v("="),v("span",{staticClass:"hljs-string"},[t._v('"https://….now.sh/no-cors"')]),t._v(">")]),v("span",{staticClass:"undefined"}),v("span",{staticClass:"hljs-tag"},[t._v("</"),v("span",{staticClass:"hljs-name"},[t._v("script")]),t._v(">")]),t._v("\n\n"),v("span",{staticClass:"hljs-comment"},[t._v("\x3c!-- 模块不会执行，因其引入的脚本未通过 CORS 检查 --\x3e")]),t._v("\n"),v("span",{staticClass:"hljs-tag"},[t._v("<"),v("span",{staticClass:"hljs-name"},[t._v("script")]),t._v(" "),v("span",{staticClass:"hljs-attr"},[t._v("type")]),t._v("="),v("span",{staticClass:"hljs-string"},[t._v('"module"')]),t._v(">")]),v("span",{staticClass:"actionscript"},[t._v("\n  "),v("span",{staticClass:"hljs-meta"},[v("span",{staticClass:"hljs-meta-keyword"},[t._v("import")]),t._v(" 'https://….now.sh/no-cors';")]),t._v("\n\n  addTextToBody("),v("span",{staticClass:"hljs-string"},[t._v('"This will not execute."')]),t._v(");\n")]),v("span",{staticClass:"hljs-tag"},[t._v("</"),v("span",{staticClass:"hljs-name"},[t._v("script")]),t._v(">")]),t._v("\n\n"),v("span",{staticClass:"hljs-comment"},[t._v("\x3c!-- CORS 检查通过，模块将会执行 --\x3e")]),t._v("\n"),v("span",{staticClass:"hljs-tag"},[t._v("<"),v("span",{staticClass:"hljs-name"},[t._v("script")]),t._v(" "),v("span",{staticClass:"hljs-attr"},[t._v("type")]),t._v("="),v("span",{staticClass:"hljs-string"},[t._v('"module"')]),t._v(" "),v("span",{staticClass:"hljs-attr"},[t._v("src")]),t._v("="),v("span",{staticClass:"hljs-string"},[t._v('"https://….now.sh/cors"')]),t._v(">")]),v("span",{staticClass:"undefined"}),v("span",{staticClass:"hljs-tag"},[t._v("</"),v("span",{staticClass:"hljs-name"},[t._v("script")]),t._v(">")])])]),v("p",[v("strong",[v("a",{attrs:{href:"https://cdn.rawgit.com/jakearchibald/2b8d4bc7624ca6a2c7f3c35f6e17fe2d/raw/fe04e60b0b7021f261e79b8ef28b0ccd132c1585/",target:"_blank"}},[t._v("Live demo")])]),t._v("。")]),t._v(" "),v("p",[t._v("与正常脚本不同，模块脚本（及其引入的脚本）是通过 CORS 获取的。这意味着，跨域模块脚本必须返回类似 "),v("code",[t._v("Access-Control-Allow-Origin: *")]),t._v(" 这样的有效的响应头。")]),t._v(" "),v("h3",{attrs:{id:"-issue"}},[t._v("浏览器 issue")]),t._v(" "),v("ul",[v("li",[t._v("Firefox 无法加载 demo 页面("),v("a",{attrs:{href:"https://bugzilla.mozilla.org/show_bug.cgi?id=1361373",target:"_blank"}},[t._v("issue")]),t._v(")。")]),t._v(" "),v("li",[t._v("Edge 加载了没有 CORS 响应头的模块("),v("a",{attrs:{href:"https://developer.microsoft.com/en-us/microsoft-edge/platform/issues/11865934/",target:"_blank"}},[t._v("issue")]),t._v(")。")])]),t._v(" "),v("h2",{attrs:{id:"-"}},[t._v("不携带凭证信息")]),t._v(" "),v("pre",[v("code",{staticClass:"hljs lang-html"},[v("span",{staticClass:"hljs-comment"},[t._v("\x3c!-- 请求脚本时会携带相关凭证 (如 cookie) --\x3e")]),t._v("\n"),v("span",{staticClass:"hljs-tag"},[t._v("<"),v("span",{staticClass:"hljs-name"},[t._v("script")]),t._v(" "),v("span",{staticClass:"hljs-attr"},[t._v("src")]),t._v("="),v("span",{staticClass:"hljs-string"},[t._v('"1.js"')]),t._v(">")]),v("span",{staticClass:"undefined"}),v("span",{staticClass:"hljs-tag"},[t._v("</"),v("span",{staticClass:"hljs-name"},[t._v("script")]),t._v(">")]),t._v("\n\n"),v("span",{staticClass:"hljs-comment"},[t._v("\x3c!-- 不会携带相关凭证 --\x3e")]),t._v("\n"),v("span",{staticClass:"hljs-tag"},[t._v("<"),v("span",{staticClass:"hljs-name"},[t._v("script")]),t._v(" "),v("span",{staticClass:"hljs-attr"},[t._v("type")]),t._v("="),v("span",{staticClass:"hljs-string"},[t._v('"module"')]),t._v(" "),v("span",{staticClass:"hljs-attr"},[t._v("src")]),t._v("="),v("span",{staticClass:"hljs-string"},[t._v('"1.js"')]),t._v(">")]),v("span",{staticClass:"undefined"}),v("span",{staticClass:"hljs-tag"},[t._v("</"),v("span",{staticClass:"hljs-name"},[t._v("script")]),t._v(">")]),t._v("\n\n"),v("span",{staticClass:"hljs-comment"},[t._v("\x3c!-- 会携带相关凭证 --\x3e")]),t._v("\n"),v("span",{staticClass:"hljs-tag"},[t._v("<"),v("span",{staticClass:"hljs-name"},[t._v("script")]),t._v(" "),v("span",{staticClass:"hljs-attr"},[t._v("type")]),t._v("="),v("span",{staticClass:"hljs-string"},[t._v('"module"')]),t._v(" "),v("span",{staticClass:"hljs-attr"},[t._v("crossorigin")]),t._v(" "),v("span",{staticClass:"hljs-attr"},[t._v("src")]),t._v("="),v("span",{staticClass:"hljs-string"},[t._v('"1.js?"')]),t._v(">")]),v("span",{staticClass:"undefined"}),v("span",{staticClass:"hljs-tag"},[t._v("</"),v("span",{staticClass:"hljs-name"},[t._v("script")]),t._v(">")]),t._v("\n\n"),v("span",{staticClass:"hljs-comment"},[t._v("\x3c!-- 不会携带相关凭证 --\x3e")]),t._v("\n"),v("span",{staticClass:"hljs-tag"},[t._v("<"),v("span",{staticClass:"hljs-name"},[t._v("script")]),t._v(" "),v("span",{staticClass:"hljs-attr"},[t._v("type")]),t._v("="),v("span",{staticClass:"hljs-string"},[t._v('"module"')]),t._v(" "),v("span",{staticClass:"hljs-attr"},[t._v("crossorigin")]),t._v(" "),v("span",{staticClass:"hljs-attr"},[t._v("src")]),t._v("="),v("span",{staticClass:"hljs-string"},[t._v('"https://other-origin/1.js"')]),t._v(">")]),v("span",{staticClass:"undefined"}),v("span",{staticClass:"hljs-tag"},[t._v("</"),v("span",{staticClass:"hljs-name"},[t._v("script")]),t._v(">")]),t._v("\n\n"),v("span",{staticClass:"hljs-comment"},[t._v("\x3c!-- 会携带相关凭证--\x3e")]),t._v("\n"),v("span",{staticClass:"hljs-tag"},[t._v("<"),v("span",{staticClass:"hljs-name"},[t._v("script")]),t._v(" "),v("span",{staticClass:"hljs-attr"},[t._v("type")]),t._v("="),v("span",{staticClass:"hljs-string"},[t._v('"module"')]),t._v(" "),v("span",{staticClass:"hljs-attr"},[t._v("crossorigin")]),t._v("="),v("span",{staticClass:"hljs-string"},[t._v('"use-credentials"')]),t._v(" "),v("span",{staticClass:"hljs-attr"},[t._v("src")]),t._v("="),v("span",{staticClass:"hljs-string"},[t._v('"https://other-origin/1.js?"')]),t._v(">")]),v("span",{staticClass:"undefined"}),v("span",{staticClass:"hljs-tag"},[t._v("</"),v("span",{staticClass:"hljs-name"},[t._v("script")]),t._v(">")])])]),v("p",[v("strong",[v("a",{attrs:{href:"https://module-script-tests-zoelmqooyv.now.sh/cookie-page",target:"_blank"}},[t._v("Live demo")])]),t._v("。")]),t._v(" "),v("p",[t._v("在请求同源的情况下，多数基于 CORS 的 API 都会发送凭证信息（credentials，如 Cookie）。但 "),v("code",[t._v("fetch()")]),t._v(" 和模块脚本恰恰例外 —— 除非手动声明，否则是不会发送相关凭证的。")]),t._v(" "),v("p",[t._v("对于一个同源的模块脚本，可以为其添加 "),v("code",[t._v("crossorigin")]),t._v(" 属性（这看起来挺怪的，我已经在规范中提出这个"),v("a",{attrs:{href:"https://github.com/whatwg/html/issues/2557",target:"_blank"}},[t._v("问题")]),t._v("了），这样在请求时就可以携带相关凭证了。如果你还想将凭证发给其他域，请使用 "),v("code",[t._v('crossorigin="use-credentials"')]),t._v("。需要注意的是，接收凭证的域必须返回 "),v("code",[t._v("Access-Control-Allow-Credentials: true")]),t._v(" 的响应头。")]),t._v(" "),v("p",[t._v("此外，还有一个与“模块只会执行一次”这条规则相关的问题。浏览器是通过 URL 来区别不同模块的，所以如果你先请求了一个模块而不携带任何凭证，紧接着又携带凭证信息去请求该模块，那么第二次得到的依然是不携带凭证的请求所返回的模块。这正是我在上面代码中的 URL 后面加上“?”的原因。")]),t._v(" "),v("h3",{attrs:{id:"-issue"}},[t._v("浏览器 issue")]),t._v(" "),v("ul",[v("li",[t._v("请求同源模块时，Chrome 会携带凭证信息("),v("a",{attrs:{href:"https://bugs.chromium.org/p/chromium/issues/detail?id=717525",target:"_blank"}},[t._v("issue")]),t._v(")。")]),t._v(" "),v("li",[t._v("即使添加了 "),v("code",[t._v("crossorigin")]),t._v(" 属性，Safari 在请求同源脚本时也不会携带凭证信息("),v("a",{attrs:{href:"https://bugs.webkit.org/show_bug.cgi?id=171550",target:"_blank"}},[t._v("issue")]),t._v(")。")]),t._v(" "),v("li",[t._v("Edge 则完全弄反了。请求同源模块时，Edge 默认会发送凭证信息，但如果手动添加了 "),v("code",[t._v("crossorigin")]),t._v(" 属性，则又不会携带 ("),v("a",{attrs:{href:"https://developer.microsoft.com/en-us/microsoft-edge/platform/issues/11865956/",target:"_blank"}},[t._v("issue")]),t._v(")。")])]),t._v(" "),v("p",[t._v("Firefox 是唯一正确实现这一点的浏览器 —— 好样的！")]),t._v(" "),v("h2",{attrs:{id:"mime-types"}},[t._v("Mime-types")]),t._v(" "),v("p",[t._v("不同于普通脚本，对于通过 module 引入的脚本，服务器必须返回"),v("a",{attrs:{href:"https://html.spec.whatwg.org/multipage/scripting.html#javascript-mime-type",target:"_blank"}},[t._v("合法的 MIME type")]),t._v("，否则脚本将不会执行。")]),t._v(" "),v("p",[v("strong",[v("a",{attrs:{href:"https://module-script-tests-zoelmqooyv.now.sh/mime",target:"_blank"}},[t._v("Live demo")])]),t._v("。")]),t._v(" "),v("h3",{attrs:{id:"-issue"}},[t._v("浏览器 issue")]),t._v(" "),v("ul",[v("li",[t._v("Edge 仍将执行 MIME type 非法的脚本("),v("a",{attrs:{href:"https://developer.microsoft.com/en-us/microsoft-edge/platform/issues/11865977/",target:"_blank"}},[t._v("issue")]),t._v(")。")])]),t._v(" "),v("hr"),t._v(" "),v("p",[t._v("以上就是我目前所学习到的所有内容。浏览器开始支持 ES6 模块，简直太开心啦~")])])},[],!1,null,null,null);_.default=component.exports}}]);