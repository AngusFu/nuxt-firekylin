(window.webpackJsonp=window.webpackJsonp||[]).push([[16],{166:function(t,v,_){"use strict";_.r(v);var e={computed:{data:function(){return{title:"[译] React 中的 AJAX 请求：获取数据的方法与时机",description:"React 中的 AJAX 请求：获取数据的方法与时机",keywords:"翻译,React",pathname:"ajax-requests-in-react",translation:{author:"Dave Ceddia",social:"https://daveceddia.com/",from:"https://daveceddia.com/ajax-requests-in-react/"},create_time:"2016-12-07",prev:{title:"[译] Bluebird 高性能揭秘",pathname:"javascript-performance-fundamentals-make-bluebird-fast"},next:{title:"前端界面 Modal 的控制",pathname:"accessible-modal"}}}}},n=_(3),component=Object(n.a)(e,function(){var t=this,v=t.$createElement,_=t._self._c||v;return _("post",{attrs:{data:t.data}},[_("p",[t._v("React 新手一开始可能会问到这样一个问题，“在 React 中如何发送 AJAX 请求呢？”")]),t._v(" "),_("p",[t._v("本文正要回答该问题。")]),t._v(" "),_("p",[t._v("首先：React 本身对获取数据的方式并无任何特殊偏好。实际上，在 React 的图景中，根本就不知道“服务器”这种东西的存在。")]),t._v(" "),_("p",[t._v("React 只是使用 "),_("strong",[t._v("props")]),t._v(" 和 "),_("strong",[t._v("state")]),t._v(" 两处的数据进行组件渲染。")]),t._v(" "),_("p",[t._v("因此，想要使用来自服务端的数据，必须将数据放入组件的 props 或 state 中。")]),t._v(" "),_("p",[t._v("你完全可以按照喜好使用服务、数据模型（额，“建立抽象”）完成这个过程，但归根结底只不过是通过 props 和 state 渲染组件。")]),t._v(" "),_("h4",{attrs:{id:"-http-"}},[t._v("选择 HTTP 工具库")]),t._v(" "),_("p",[t._v("要从服务端拿到数据，首先得有一个 HTTP 工具库。现成的轮子数都数不清。它们最终做的事情都一样，但在一些特性上有所不同。")]),t._v(" "),_("p",[t._v("喜欢 Promise？那就试试  "),_("a",{attrs:{href:"https://github.com/mzabriskie/axios",target:"_blank"}},[t._v("axios")]),t._v(" 吧。")]),t._v(" "),_("p",[t._v("不喜欢 Promise，对回调函数情有独钟？可以看一眼 "),_("a",{attrs:{href:"https://github.com/visionmedia/superagent",target:"_blank"}},[t._v("superagent")]),t._v("。")]),t._v(" "),_("p",[t._v("要不试试将要成为标准的一些工具？"),_("a",{attrs:{href:"https://github.com/github/fetch",target:"_blank"}},[t._v("fetch")]),t._v(" 可能是你的菜。")]),t._v(" "),_("p",[t._v("这些其实根本不重要。没有“最佳”工具。")]),t._v(" "),_("p",[t._v("有些人可能会说，"),_("code",[t._v("fetch")]),t._v(" 是最好的，因为 fetch 差不多已经是标准了。但我敢打赌，就算fetch "),_("strong",[t._v("真正")]),t._v("成为标准，还是会有人喜欢、使用一些与之匹敌的 HTTP 工具库。所以随你怎么选咯。")]),t._v(" "),_("p",[t._v("我个人比较喜欢 "),_("a",{attrs:{href:"https://github.com/mzabriskie/axios",target:"_blank"}},[t._v("axios")]),t._v("，这也是本文示例所使用的。不过，认真的说，如果你偏偏不喜欢它，那就选其他的呗。")]),t._v(" "),_("h4",{attrs:{id:"-"}},[t._v("获取数据")]),t._v(" "),_("p",[t._v("下面是一个简单的示例组件，它从 Reddit 站点获取文章列表。先看一眼，后面会讲述代码是如何工作的。")]),t._v(" "),_("pre",[_("code",{staticClass:"hljs lang-javascript"},[_("span",{staticClass:"hljs-keyword"},[t._v("import")]),t._v(" React "),_("span",{staticClass:"hljs-keyword"},[t._v("from")]),t._v(" "),_("span",{staticClass:"hljs-string"},[t._v("'react'")]),t._v(";\n"),_("span",{staticClass:"hljs-keyword"},[t._v("import")]),t._v(" ReactDOM "),_("span",{staticClass:"hljs-keyword"},[t._v("from")]),t._v(" "),_("span",{staticClass:"hljs-string"},[t._v("'react-dom'")]),t._v(";\n"),_("span",{staticClass:"hljs-keyword"},[t._v("import")]),t._v(" axios "),_("span",{staticClass:"hljs-keyword"},[t._v("from")]),t._v(" "),_("span",{staticClass:"hljs-string"},[t._v("'axios'")]),t._v(";\n\n"),_("span",{staticClass:"hljs-class"},[_("span",{staticClass:"hljs-keyword"},[t._v("class")]),t._v(" "),_("span",{staticClass:"hljs-title"},[t._v("FetchDemo")]),t._v(" "),_("span",{staticClass:"hljs-keyword"},[t._v("extends")]),t._v(" "),_("span",{staticClass:"hljs-title"},[t._v("React")]),t._v("."),_("span",{staticClass:"hljs-title"},[t._v("Component")]),t._v(" ")]),t._v("{\n  "),_("span",{staticClass:"hljs-keyword"},[t._v("constructor")]),t._v("(props) {\n    "),_("span",{staticClass:"hljs-keyword"},[t._v("super")]),t._v("(props);\n\n    "),_("span",{staticClass:"hljs-keyword"},[t._v("this")]),t._v(".state = {\n      "),_("span",{staticClass:"hljs-attr"},[t._v("posts")]),t._v(": []\n    };\n  }\n\n  componentDidMount() {\n    axios.get("),_("span",{staticClass:"hljs-string"},[t._v("`http://www.reddit.com/r/"),_("span",{staticClass:"hljs-subst"},[t._v("${"),_("span",{staticClass:"hljs-keyword"},[t._v("this")]),t._v(".props.subreddit}")]),t._v(".json`")]),t._v(")\n      .then("),_("span",{staticClass:"hljs-function"},[_("span",{staticClass:"hljs-params"},[t._v("res")]),t._v(" =>")]),t._v(" {\n        "),_("span",{staticClass:"hljs-keyword"},[t._v("const")]),t._v(" posts = res.data.data.children.map("),_("span",{staticClass:"hljs-function"},[_("span",{staticClass:"hljs-params"},[t._v("obj")]),t._v(" =>")]),t._v(" obj.data);\n        "),_("span",{staticClass:"hljs-keyword"},[t._v("this")]),t._v(".setState({ posts });\n      });\n  }\n\n  render() {\n    "),_("span",{staticClass:"hljs-keyword"},[t._v("return")]),t._v(" (\n      "),_("span",{staticClass:"xml"},[_("span",{staticClass:"hljs-tag"},[t._v("<"),_("span",{staticClass:"hljs-name"},[t._v("div")]),t._v(">")]),t._v("\n        "),_("span",{staticClass:"hljs-tag"},[t._v("<"),_("span",{staticClass:"hljs-name"},[t._v("h1")]),t._v(">")]),t._v("{`/r/${this.props.subreddit}`}"),_("span",{staticClass:"hljs-tag"},[t._v("</"),_("span",{staticClass:"hljs-name"},[t._v("h1")]),t._v(">")]),t._v("\n        "),_("span",{staticClass:"hljs-tag"},[t._v("<"),_("span",{staticClass:"hljs-name"},[t._v("ul")]),t._v(">")]),t._v("\n          {this.state.posts.map(post =>\n            "),_("span",{staticClass:"hljs-tag"},[t._v("<"),_("span",{staticClass:"hljs-name"},[t._v("li")]),t._v(" "),_("span",{staticClass:"hljs-attr"},[t._v("key")]),t._v("="),_("span",{staticClass:"hljs-string"},[t._v("{post.id}")]),t._v(">")]),t._v("{post.title}"),_("span",{staticClass:"hljs-tag"},[t._v("</"),_("span",{staticClass:"hljs-name"},[t._v("li")]),t._v(">")]),t._v("\n          )}\n        "),_("span",{staticClass:"hljs-tag"},[t._v("</"),_("span",{staticClass:"hljs-name"},[t._v("ul")]),t._v(">")]),t._v("\n      "),_("span",{staticClass:"hljs-tag"},[t._v("</"),_("span",{staticClass:"hljs-name"},[t._v("div")]),t._v(">")])]),t._v("\n    );\n  }\n}\n\nReactDOM.render(\n  "),_("span",{staticClass:"xml"},[_("span",{staticClass:"hljs-tag"},[t._v("<"),_("span",{staticClass:"hljs-name"},[t._v("FetchDemo")]),t._v(" "),_("span",{staticClass:"hljs-attr"},[t._v("subreddit")]),t._v("="),_("span",{staticClass:"hljs-string"},[t._v('"reactjs"')]),t._v("/>")]),t._v(",\n  document.getElementById('root')\n);")])])]),_("h3",{attrs:{id:"-"}},[t._v("如何工作")]),t._v(" "),_("p",[t._v("首先引入 "),_("code",[t._v("axios")]),t._v("。")]),t._v(" "),_("pre",[_("code",{staticClass:"hljs lang-javascript"},[_("span",{staticClass:"hljs-keyword"},[t._v("import")]),t._v(" axios "),_("span",{staticClass:"hljs-keyword"},[t._v("from")]),t._v(" "),_("span",{staticClass:"hljs-string"},[t._v("'axios'")]),t._v(";")])]),_("p",[t._v("constructor 方法非常标准，调用 "),_("code",[t._v("super")]),t._v("，然后初始化 state，设置一个空的 "),_("code",[t._v("posts")]),t._v(" 数组。")]),t._v(" "),_("p",[t._v("真正神奇的事情发生在 "),_("code",[t._v("componentDidMount")]),t._v(" 方法中。组件首次“挂载”（mount）时，该方法就会执行。在组件生命周期中，该方法只会执行"),_("strong",[t._v("一次")]),t._v("。")]),t._v(" "),_("p",[_("strong",[t._v("TL;DR:  在 "),_("code",[t._v("componentDidMount")]),t._v(" 方法中获取服务端数据")])]),t._v(" "),_("p",[_("code",[t._v("componentDidMount")]),t._v(" 方法中，根据传入的"),_("code",[t._v("subreddit")]),t._v("属性，调用 "),_("code",[t._v("axios.get")]),t._v(" 方法获取数据。反引号中是 ES6 模板字符串，可能如你所想，"),_("code",[t._v("${...}")]),t._v(" 部分会被其中表达式的值所替换，因此传给 "),_("code",[t._v("axios.get")]),t._v(" 的 URL 实际上是 "),_("code",[t._v("http://www.reddit.com/r/reactjs.json")]),t._v("。")]),t._v(" "),_("p",[t._v("此处需注意两点，和 Reddit 有关：")]),t._v(" "),_("ul",[_("li",[_("p",[t._v("可以在 Reddit 网站下面所有的 URL 后面添加 "),_("code",[t._v(".json")]),t._v(" 后缀，以获取 JSON 格式的内容。")])]),t._v(" "),_("li",[_("p",[t._v("如果去掉 "),_("code",[t._v("www")]),t._v("，会产生 CORS 错误（至少我碰到了这个错误）。")])])]),t._v(" "),_("p",[t._v("因为 Axios 使用了 Promise，所以可以通过 "),_("code",[t._v(".then")]),t._v(" 方法链式处理响应。经过一些处理后，"),_("code",[t._v("posts")]),t._v(" 被提取出来了，紧接着是重点：")]),t._v(" "),_("p",[t._v("传入新的 posts 数组，使用 "),_("code",[t._v("this.setState")]),t._v(" 方法更新组件状态。这会导致重新渲染，接下来文章列表就显示出来了。")]),t._v(" "),_("p",[t._v("这就是所有的一切啦哈哈！")]),t._v(" "),_("h3",{attrs:{id:"-"}},[t._v("思考题：添加加载指示")]),t._v(" "),_("p",[t._v('知道怎样修改代码，在请求尚未返回时添加一个 "Loading..." 消息吗？')]),t._v(" "),_("p",[t._v("提示：在 state 中设置一个标志，一旦请求完成则将其切换其值。在 render 函数中使用这个标志显示加载提示。")]),t._v(" "),_("p",[t._v("如果想看示例代码（包括加载提示以及附加奖励 "),_("code",[t._v("error state")]),t._v("~），可以点击"),_("a",{attrs:{href:"https://daveceddia.com/freebies/react-ajax-example.zip",target:"_blank"}},[t._v("这里")]),t._v("下载可运行的例子，无需注册哟~")]),t._v(" "),_("p",[t._v("解压文件，依次执行 "),_("code",[t._v("npm install")]),t._v(" 和 "),_("code",[t._v("npm start")]),t._v("。示例基于棒棒哒 "),_("a",{attrs:{href:"https://daveceddia.com/create-react-app-official-project-generator",target:"_blank"}},[t._v("Create React App")]),t._v(" 创建。")])])},[],!1,null,null,null);v.default=component.exports}}]);