<!doctype html>
<html data-n-head-ssr data-n-head="">
  <head>
    <title data-n-head="true">[译] Emoji.prototype.length  —— Unicode 字符那些事儿 | 文蔺的博客</title><meta data-n-head="true" charset="utf-8"><meta data-n-head="true" name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta data-n-head="true" name="description" content="文蔺的前端学习记录，国外技术文章翻译，个人学习心得等等这些都会记录在这里。"><meta data-n-head="true" name="keywords" content="翻译,Unicode,Emoji,JavaScript"><meta data-n-head="true" name="description" content="Emoji.prototype.length  —— Unicode 字符那些事儿"><link data-n-head="true" rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/static/0501d49c081ea86e209e.css">
  </head>
  <body data-n-head="">
    <div data-server-rendered="true" id="__nuxt"><!----><div id="__layout"><div class="wrapper"><nav id="sidebar" class="behavior_1"><div class="wrap"><div class="profile"><a href="/" class="nuxt-link-active"><img src="/imgs/avatar.jpg" alt="文蔺的博客"></a> <span>文蔺的博客</span></div> <ul class="buttons"><li><a href="/" title="主页" class="nuxt-link-active"><i class="iconfont icon-home"></i> <span> 主页</span></a></li><li><a href="/archives" title="归档"><i class="iconfont icon-archive"></i> <span> 归档</span></a></li><li><a href="/slides" title="Slides"><i class="iconfont icon-archive"></i> <span> Slides</span></a></li><li><a href="/about" title="关于"><i class="iconfont icon-user"></i> <span> 关于</span></a></li><li><a href="/link" title="关注"><i class="iconfont icon-link"></i> <span> 关注</span></a></li><li><a href="/collection" title="收藏"><i class="iconfont icon-archive"></i> <span> 收藏</span></a></li></ul></div> <ul class="buttons"><li><a href="https://github.com/AngusFu/" rel="nofollow" target="_blank" class="inline"><i title="GitHub" class="iconfont icon-github-v"></i></a> <!----> <!----> <a href="/atom.xml" target="_blank" class="inline"><i title="RSS" class="iconfont icon-rss-v"></i></a> <a href="/search" class="inline"><i title="Search" class="iconfont icon-search"></i></a></li></ul></nav> <div id="header"><div class="btn-bar"><i></i></div> <h1><a href="/" class="nuxt-link-active">文蔺的博客</a></h1> <a href="/about/" class="me"><img src="/imgs/avatar.jpg" alt="文蔺的博客"></a></div> <div id="sidebar-mask" style="display:none"></div> <div id="main" class="main"><div id="page-post"><article class="post detail"><div class="meta"><div class="date">2017-04-27</div></div> <h1 class="title">[译] Emoji.prototype.length  —— Unicode 字符那些事儿</h1> <div class="entry-content"><blockquote><p style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">
          原文作者:
          <a target="_blank" href="https://www.contentful.com/blog/2016/12/06/unicode-javascript-and-the-emoji-family/">@Stefan Judis</a> <br>原文地址:
          <a target="_blank" href="https://www.contentful.com/blog/2016/12/06/unicode-javascript-and-the-emoji-family/">https://www.contentful.com/blog/2016/12/06/unicode-javascript-and-the-emoji-family/</a> <br>译文地址:
          <a target="_blank" href="http://www.wemlion.com/post/unicode-javascript-and-the-emoji-family">http://www.wemlion.com/post/unicode-javascript-and-the-emoji-family</a> <br>本文由
          <a target="_blank" href="http://www.wemlion.com">文蔺</a> 翻译，转载请保留此声明。
          <br>著作权属于原作者，本译文仅用于学习、研究和交流目的，请勿用于商业目的。
        </p></blockquote> <blockquote><p>译者注：本文用到了很多 emoji 符号，建议不要使用 Windows 系统阅读本文。</p></blockquote> <p><img alt=""></p> <p>如今 emoji 已经成为文字交流的重要基础。离开这些精巧的符号，只怕很多对话早就因尴尬和误解而草草收场了。还记得当年短信风行时的那些事吗？</p> <p>没有笑脸表情的文字聊天过程中，常常会得到“你不是在开玩笑吧？”这样的回复，以免将一些无聊的笑话信以为真。后来并没有花多久的时间，大家都明白了，单纯靠文字来理解那些幽默与调戏并不那么容易（但不管怎么说，这种套路确实应该少一些）。世界上首个 emoji 诞生之后不久，emoji 很快成为文字交流中不可或缺的要素。</p> <p>日用之而不觉，我从未思考过 emoji 在技术层面上是如何工作的。但无论如何，它们肯定和 Unicode 有关系，尽管我确实不了解实际机制。老实说，我倒也没怎么在意……</p> <p>读了 <a href="https://twitter.com/wesbos/status/769229581509332992" target="_blank">Wes Bos 的一条推文</a>之后，我的想法被彻底改变。Wes Bos 在这条推文中分享了一些 JavaScript 字符串操作，其中也包括表示家庭的 family emoji。</p> <pre><code class="hljs lang-javascript">[...<span class="hljs-string">'👨‍👩‍👦'</span>]   <span class="hljs-comment">// ["👨", "‍", "👩", "‍", "👦"]</span>
<span class="hljs-string">'👨‍👩‍👦'</span>.length <span class="hljs-comment">// 8</span></code></pre><p>OK, 对字符串使用<a href="https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Operators/Spread_operator" target="_blank">展开运算操作</a>倒没什么稀奇的，可是一个符号拆分出了三个符号外加两个空字符，我颇有些疑惑。接着看到该符号的 <code>length</code>（长度） 竟然是 8，愈加困惑，展开数组中明明就只有五项啊。</p> <p>当即测试这段代码，丝毫不爽，果然如 Wes 所述。什么鬼？不深入了解 Unicode、JavaScript 和 emoji，就难解我心头之惑。</p> <h2 id="unicode-">Unicode 简介</h2> <p>JavaScript 为什么会如此处理 emoji 呢？欲要理解个中原理，还需深入去看 Unicode 本身。</p> <p>Unicode 是国际计算机工业标准。它是一个字母（或字符、符号）对应一个数值的映射集。如果没有 Unicode，像那些含有像德文字母 ß、ä、ö 这样的特殊字符的文档，就无法在其他不使用这类字符的系统上共享。感谢 Unicode 的跨平台、跨系统编码。</p> <p>Unicode 中共有 1,114,112 个不同的码点（code point），它们通常使用 <code>U+</code> 加上一个十六进制数字表示。Unicode 码点取值范围是 <code>U+0000</code> 到 <code>U+10FFFF</code>。</p> <p>这些码点总数超过十亿，它们被分为 17 个“平面”（plane）。每个平面包含六万五千多个码点。其中，最重要的平面是“多语言基本平面”（Basic Multilingual Plane，BMP），范围是 <code>U+0000</code> 至 <code>U+FFFF</code>。</p> <p>BMP 基本平面几乎包含了所有现代语言中使用到的字符，以及很多其他符号。其余 16 个平面称作“补充平面”（Supplementary Planes），其中包含一些不同的案例，比如——聪明如你，可能已经猜到了——大多数 emoji 符号的定义。</p> <h2 id="emoji-">emoji 是如何定义的</h2> <p>我们今天所知的 emoji 至少由一个 Unicode 码点所定义。可以看下 <a href="http://unicode.org/emoji/charts/full-emoji-list.html" target="_blank">Full Emoji Data list</a>，其中列出了所有定义的 emoji。你可能会问，Unicode 目前到底定义了多少不同的 emoji 呢？答案是“视情况而定”，这可是计算机科学中常见的答案。要回答这个问题，首先需要理解 Unicode。</p> <p>如前面所述，emoji <strong>至少</strong>由一个码点定义。这也就意味着，还有一些 emoji 是由几种不同的 emoji 和码点组合而成的。这些组合称作序列（sequence）。有了序列，就可以做一些别的事，比方说，修饰那些中性 emoji （通常用黄色皮肤展示），让它们符合你的风格。</p> <h3 id="-">修饰序列</h3> <p>犹记得当初在聊天中发现可以按自己的肤色修饰“点赞”表情的时候，我感受到了一种包容，这个表情与我之间的联系似乎变得更加紧密了。</p> <p>Unicode 中有五种修饰符，用于修饰与人相关的中性 emoji。不同的修饰符会产生不同肤色效果。修饰符基于 <a href="https://en.wikipedia.org/wiki/Fitzpatrick_scale" target="_blank">Fitzpatrick 量表</a> 设定，其编码范围为<code>U+1F3FB</code>~<code>U+1F3FF</code>。</p> <p>下面是使用修饰符修改 emoji 肤色的示例：</p> <pre><code class="hljs lang-javascript"><span class="hljs-comment">// U+1F467 + U+1F3FD</span>
👧 + 🏽
> 👧🏽</code></pre><p>在那些支持修饰序列的操作系统中，为码点值为 <code>U+1F467</code> 的小女孩 emoji 添加修饰符之后，就能得一个肤色发生变化的小女孩表情。</p> <h3 id="-">零宽连接序列</h3> <p>与人相关的，可不止肤色这一种。再看看前面提到的家庭 emoji，显然并非所有家庭都是由爸爸、妈妈、儿子三者组成的。</p> <p>Unicode 中包括一个中性的表示家庭的码点（<code>U+1F46A</code>- ‍👪），但这并非家庭真实写照。不过，还可以使用“零宽连接符”序列（Zero-Width-Joiner sequence）创建一些不同的家庭符号。</p> <p>先来谈谈工作原理：Unicode 中有一个称为零宽连接符（<code>U+200D</code>）的码点。它就像胶水一样，将两个码点粘在一起以单个符号的形式展现。</p> <p>想想要组成一个家庭的话，需要将哪些符号连在一起呢？很简单，两个大人，一个孩子。使用零宽连接符很容易就能拼出各种各样的家庭符号。</p> <pre><code class="hljs lang-javascript"><span class="hljs-comment">// 中性家庭</span>
<span class="hljs-comment">// U+1F46A</span>
> 👪

<span class="hljs-comment">// 零宽连接序列: 家庭 (男人, 女人, 男孩)</span>
<span class="hljs-comment">// U+1F468 + U+200D + U+1F469 + U+200D + U+1F466</span>
<span class="hljs-comment">// 👨‍ + U+200D + 👩‍ + U+200D + 👦</span>
> ‍👨‍👩‍👦

<span class="hljs-comment">// 零宽连接序列: 家庭 (女人, 女人, 女孩)</span>
<span class="hljs-comment">// U+1F469 + U+200D + U+1F469 + U+200D + U+1F467</span>
<span class="hljs-comment">// 👩‍ + U+200D + 👩‍ U+200D + 👧</span>
> ‍👩‍👩‍👧

<span class="hljs-comment">// 零宽连接序列: 家庭 (女人, 女人, 女孩, 女孩)</span>
<span class="hljs-comment">// U+1F469 + U+200D + U+1F469 + U+200D + U+1F467 + U+200D + U+1F467</span>
<span class="hljs-comment">// 👩‍ + U+200D + 👩‍ + U+200D + 👧‍ + U+200D + 👧</span>
> ‍👩‍👩‍👧‍👧</code></pre><p>可以查看<a href="http://unicode.org/emoji/charts/emoji-zwj-sequences.html" target="_blank">全部的零宽连接序列</a>，其中的类型更加多种多样，比如，带着两个女孩的父亲。不幸的是，在本文写作的时候，这些序列的支持度并不是很好。好在零宽连接序列还能优雅降级，单个码点分别独立显示。这有助于保持特殊组合符号的语义。</p> <pre><code class="hljs lang-javascript"><span class="hljs-comment">// 零宽连接序列: 家庭 (男人, 女孩, 女孩)</span>
<span class="hljs-comment">// U+1F468 + U+200D + U+1F467 + U+200D + U+1F467</span>
<span class="hljs-comment">// 👨‍ + U+200D + 👧 + U+200D + 👧</span>
> ‍👨‍👧‍👧  -> 尚不支持的情况下以这种形式显示</code></pre><p>还有很棒的一点是，上面这些原则并不是仅仅针对家庭 emoji 的。来看看著名的 David Bowie emoji（该 emoji 的真名应该是“男歌手”）。这个表情实际上也是一个零宽连接序列，由一个男士（<code>U+1F468</code>）、一个零宽连接符和一个耳机（<code>U+1F3A4</code>）组成。</p> <p><img alt="Davide Bowie Emoji"></p> <p>可能你已经猜到了，将男人(<code>U+1F468</code>)替换成女人(<code>U+1F469</code>)，结果就是一个女歌手（女版 David Bowie）。若再引入可以修改肤色的修饰符，还可能出现一个黑人女歌手。棒棒哒！</p> <pre><code class="hljs lang-javascript"><span class="hljs-comment">// 零宽连接序列: 女歌手</span>
<span class="hljs-comment">// U+1F469 + U+1F3FF + U+200D + U+1F3A4</span>
<span class="hljs-comment">// 👩 + 🏿 + U+200D + 🎤</span>
> 👩🏿🎤 -> 尚不支持的情况下以这种形式显示</code></pre><p>然而，依然不幸，目前这种序列的支持程度也并不是很好。</p> <h3 id="emoji-">emoji 数量</h3> <p>回答 emoji 到底有多少种，得看怎么算了。是可用于展示 emoji 的不同码点的数量吗？需要计算可以展示的各种不同的 emoji 变体吗？</p> <p>如果计算可展示的不同 emoji（包括所有序列、变体），总数是 2198。如果你对计算感兴趣，可以看下 <a href="http://unicode.org/" target="_blank">unicode.org</a> 上的<a href="http://www.unicode.org/reports/tr51/index.html#Identification" target="_blank">完整章节</a>。</p> <p>除了“如何计算”这个问题之外，还有一个现实问题：新的 emoji 和 Unicode 字符在不断加入规范，想要记录准确的总数还是挺困难的。</p> <h3 id="javascript-16-">JavaScript 字符串与 16 位代码单元</h3> <p>JavaScript 字符串的格式是 UTF-16，使用一个 16 位的代码单元表示最常见的字符。掐指一算，这意味着一个代码单元能放下六万五千多个码点（译者注：<code>2^16=65536</code>），几乎和 BMP 一一对应。下面使用 BMP 中的一些符号试试看：</p> <pre><code class="hljs lang-javascript"><span class="hljs-string">'ﾂ'</span>.length  <span class="hljs-comment">// 1 -> U+FF82</span>
<span class="hljs-string">'⛷'</span>.length <span class="hljs-comment">// 1 -> U+26F7</span>
<span class="hljs-string">'☃'</span>.length <span class="hljs-comment">// 1 -> U+9731</span></code></pre><p>不出所料，这些字符的 <code>length</code> 值正好是 1。可是，如果要用到的字符不在 BMP 范围内呢？</p> <h3 id="-">代理对</h3> <p>还可以将两个 BMP 码点结合在一起，形成一个新的码点，这就是代理对（surrogate pair）。</p> <p><code>U+D800</code> 到 <code>U+DBFF</code> 之间的保留码点用于所谓的高级代理（又作 leading surrogates，主代理），<code>U+DC00</code> 到 <code>U+DFFF</code> 之间的保留码点则用于低级代理（又作 trailing surrogates，尾代理）。</p> <p>这两类码点总是同时成对出现，高级代理后面跟着低级代理。然后通过特定算法对超出范围的码点进行解码。</p> <p>一起来看下面的例子：</p> <pre><code class="hljs lang-javascript"><span class="hljs-string">'👨'</span>.length          <span class="hljs-comment">// 2</span>
<span class="hljs-string">'👨'</span>.charCodeAt(<span class="hljs-number">0</span>)   <span class="hljs-comment">// 55357  -> U+D83D // 返回主代理的码点</span>
<span class="hljs-string">'👨'</span>.charCodeAt(<span class="hljs-number">1</span>)   <span class="hljs-comment">// 56424  -> U+DC68 // (译者注：这个是尾代理码点)</span>
<span class="hljs-string">'👨'</span>.codePointAt(<span class="hljs-number">0</span>)  <span class="hljs-comment">// 128104 -> U+1F468 // 返回组合在一起的代理的码点</span>
<span class="hljs-string">'👨'</span>.codePointAt(<span class="hljs-number">1</span>)  <span class="hljs-comment">// 56424  -> U+DC68</span></code></pre><p>中性的男性 emoji 的码点是 <code>U+1F468</code>，在 JavaScript 中无法通过单个代码单元来表示。这就是为何需要使用代理对的原因，通过两个单独的代码单元组成这个表情。</p> <p>分析 JavaScript 中的代码单元，有两种可能有用的方法。一个是 <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/charCodeAt" target="_blank"><code>charCodeAt</code></a>，遇上代理对的时候，该方法会分别返回每个代理的码点。另一个方法是 <a href="https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Global_Objects/String/codePointAt" target="_blank"><code>codePointAt</code></a>，遇上主代理时会返回代理对组合的码点，遇上尾代理时则返回尾代理的码点。</p> <p>看起来有点恐怖？深有同感。强烈建议仔细 MDN 上的相关文章。</p> <p>再从数学方面深入看一下这个代表男性的 emoji。通过 <code>charCodeAt</code> 方法，我们可以检索到组成代理对的独立代码单元。</p> <p>我们得到的第一个值是 <code>55357</code>，也就是十六进制的 <code>D83D</code>，这个是高级代理。得到的第二个值是 <code>56424</code>，即十六进制的 <code>DC68</code>，这是低级代理。这两个典型的代理对经过运算后便得到了 <code>128104</code>，映射到 emoji 就是男性符号。</p> <pre><code class="hljs lang-javascript"><span class="hljs-comment">// 十六进制</span>
<span class="hljs-number">0x1F468</span> = (<span class="hljs-number">0xD83D</span> - <span class="hljs-number">0xD800</span>) * <span class="hljs-number">0x400</span> + <span class="hljs-number">0xDC68</span> - <span class="hljs-number">0xDC00</span> + <span class="hljs-number">0x10000</span>
<span class="hljs-comment">// 十进制</span>
<span class="hljs-number">128104</span> = (<span class="hljs-number">55357</span> - <span class="hljs-number">55296</span>) * <span class="hljs-number">1024</span> + <span class="hljs-number">56424</span> - <span class="hljs-number">56320</span> + <span class="hljs-number">65536</span></code></pre><h3 id="javascript-length-">JavaScript 中的 <code>length</code> 属性与码点数量</h3> <p>学习了码点的相关知识，现在可以理解这让人困惑的 <code>length</code> 属性了。它会返回的是码点的数量，而非一开始所认为的肉眼所见符号的数量。在处理 JavaScript 字符串的时候，这让寻找 bug 变得相当麻烦。所以处理 BMP 平面之外的符号时千万要当心。</p> <h2 id="-">小结</h2> <p>再回到 Wes 最初的例子。</p> <pre><code class="hljs lang-javascript"><span class="hljs-comment">// 零宽连接序列: family (man, woman, boy)</span>
<span class="hljs-comment">// U+1F468 + U+200D + U+1F469 + U+200D + U+1F466</span>
[...<span class="hljs-string">'👨‍👩‍👦'</span>]   <span class="hljs-comment">// ["👨", "‍", "👩", "‍", "👦"]</span>
<span class="hljs-string">'👨‍👩‍👦'</span>.length <span class="hljs-comment">// 8</span>

<span class="hljs-comment">// neutral family</span>
<span class="hljs-comment">// U+1F46A</span>
[...<span class="hljs-string">'👪'</span>]   <span class="hljs-comment">// ['👪']</span>
<span class="hljs-string">'👪'</span>.length <span class="hljs-comment">// 2</span></code></pre><p>我们在这里看到的家庭 emoji 由一个男性、一个女性、一个男孩组成。展开运算符会检查所有码点。我们所看到的空字符并非真正的空字符，而是零宽连接符。读取该 emoji 的 <code>length</code> 属性会得到 8，其中每个 emoji 的 <code>length</code> 为 2，每个零宽连接符的 <code>length</code> 为 1，合起来正好是 8。</p> <p>我真心享受深挖 Unicode 的过程。如果你同样对这个话题感兴趣，必须向你推荐 <a href="https://twitter.com/FakeUnicode" target="_blank">@fakeunicode</a> 这个 Twitter 账号。你知道吗，甚至还有关于 emoji 的 <a href="http://podcast.emojiwrap.com/" target="_blank">podcast</a>  和<a href="http://2016.emojicon.co/" target="_blank">会议</a> 呢。我会保持关注的，了解这些每天都在使用的小符号真是有趣极了，你可能也会感兴趣的。</p></div></article> <nav class="pagination"><a href="/post/fun-hacks-faster-content" title="[译] 内容加速黑科技趣谈" class="prev">« [译] 内容加速黑科技趣谈</a> <a href="/post/get-root-domain-of-a-site" title="笔记：如何获取网站根域名" class="next">笔记：如何获取网站根域名 »</a></nav></div> <footer id="footer" class="inner">
      © 2022 -  文蔺的博客
      
        <span> - </span> <a href="/" class="nuxt-link-active">www.wemlion.com</a> <br>
      Powered by <a target="_blank" href="https://nuxtjs.org">Nuxt.js</a> & <a target="_blank" rel="nofollow" href="https://firekylin.org" class="external">FireKylin</a></footer></div></div></div></div><script>window.__NUXT__={layout:"default",data:[{}],error:null,serverRendered:!0}</script><script src="/static/c418fb652629ac1ad5ca.js" defer></script><script src="/static/2899215dbed53aff0e3c.js" defer></script><script src="/static/a04af2434d342797c405.js" defer></script><script src="/static/a9e13b4b84fcd888d410.js" defer></script><script src="/static/0329710550037b626a84.js" defer></script>
  </body>
</html>
