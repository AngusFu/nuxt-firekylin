<!doctype html>
<html data-n-head-ssr data-n-head="">
  <head>
    <title data-n-head="true">[译] No WebSockets Over HTTP2 | 文蔺的博客</title><meta data-n-head="true" charset="utf-8"><meta data-n-head="true" name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta data-n-head="true" name="description" content="文蔺的前端学习记录，国外技术文章翻译，个人学习心得等等这些都会记录在这里。"><meta data-n-head="true" name="keywords" content="翻译,HTTP2,WebSocket"><meta data-n-head="true" name="description" content="No WebSockets Over HTTP2"><link data-n-head="true" rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/static/0501d49c081ea86e209e.css">
  </head>
  <body data-n-head="">
    <div data-server-rendered="true" id="__nuxt"><!----><div id="__layout"><div class="wrapper"><nav id="sidebar" class="behavior_1"><div class="wrap"><div class="profile"><a href="/" class="nuxt-link-active"><img src="/imgs/avatar.jpg" alt="文蔺的博客"></a> <span>文蔺的博客</span></div> <ul class="buttons"><li><a href="/" title="主页" class="nuxt-link-active"><i class="iconfont icon-home"></i> <span> 主页</span></a></li><li><a href="/archives" title="归档"><i class="iconfont icon-archive"></i> <span> 归档</span></a></li><li><a href="/slides" title="Slides"><i class="iconfont icon-archive"></i> <span> Slides</span></a></li><li><a href="/about" title="关于"><i class="iconfont icon-user"></i> <span> 关于</span></a></li><li><a href="/link" title="关注"><i class="iconfont icon-link"></i> <span> 关注</span></a></li><li><a href="/collection" title="收藏"><i class="iconfont icon-archive"></i> <span> 收藏</span></a></li></ul></div> <ul class="buttons"><li><a href="https://github.com/AngusFu/" rel="nofollow" target="_blank" class="inline"><i title="GitHub" class="iconfont icon-github-v"></i></a> <!----> <!----> <a href="/atom.xml" target="_blank" class="inline"><i title="RSS" class="iconfont icon-rss-v"></i></a> <a href="/search" class="inline"><i title="Search" class="iconfont icon-search"></i></a></li></ul></nav> <div id="header"><div class="btn-bar"><i></i></div> <h1><a href="/" class="nuxt-link-active">文蔺的博客</a></h1> <a href="/about/" class="me"><img src="/imgs/avatar.jpg" alt="文蔺的博客"></a></div> <div id="sidebar-mask" style="display:none"></div> <div id="main" class="main"><div id="page-post"><article class="post detail"><div class="meta"><div class="date">2016-06-24</div></div> <h1 class="title">[译] No WebSockets Over HTTP2</h1> <div class="entry-content"><blockquote><p style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">
          原文作者:
          <a target="_blank" href="https://twitter.com/bagder">@Daniel Stenberg</a> <br>原文地址:
          <a target="_blank" href="https://daniel.haxx.se/blog/2016/06/15/no-websockets-over-http2/">https://daniel.haxx.se/blog/2016/06/15/no-websockets-over-http2/</a> <br>译文地址:
          <a target="_blank" href="http://www.wemlion.com/post/no-websockets-over-http2">http://www.wemlion.com/post/no-websockets-over-http2</a> <br>本文由
          <a target="_blank" href="http://www.wemlion.com">文蔺</a> 翻译，转载请保留此声明。
          <br>著作权属于原作者，本译文仅用于学习、研究和交流目的，请勿用于商业目的。
        </p></blockquote> <blockquote><p>译者注： 《深入浅出 Node.js》第七章讲述 WebSocket 服务的构建中，对本文中反复提到的 <code>Upgrade</code> 有比较详细的说明。</p> <p>NO WEBSOCKETS OVER HTTP/2.</p></blockquote> <p>我这样说的意思是，在 HTTP/2 协议里，无法像在 HTTP/1.1 中把连接（connection）协商或提升为 WebSocket那样，如<a href="https://tools.ietf.org/html/rfc6455" target="_blank">RFC 6455</a> 所描述的 —— 这个规范（<a href="https://tools.ietf.org/html/rfc6455" target="_blank">RFC 6455</a>）详述了在一个 HTTP/1.1 请求中，客户端如何使用 <code>Upgrade:</code>将连 http 接转换为 WebSocket 连接。</p> <p>注意 WebSocket 并非 HTTP/1 规范的一部分，它只是使用了 HTTP/1 的协议细节将 HTTP 连接转换为 WebSocket 连接。 类似地，HTTP/2 之上的 WebSocket 也不会成为 HTTP/2 规范的一部分，而是成为独立的一部分。</p> <p>（附注：<code>Upgrade:</code> 的机制，和在服务端支持的情况下，非 https 的HTTP/1.1 连接能<a href="http://httpwg.org/specs/rfc7540.html#discover-http" target="_blank">升级为 HTTP/2</a> 是一样的。）</p> <p><img alt="chinese-socket"></p> <h2 id="-">草案</h2> <p>曾经有一份提交的<a href="https://tools.ietf.org/html/draft-hirano-httpbis-websocket-over-http2-01" target="_blank">草案</a>描述了 HTTP/2 下的 WebSocket 如何实现。那时 IETF 工作组并没有对它表现出任何特别的兴趣，而且在我看来，很少有工作组有兴趣捡起这个球把它继续滚下去。它就这样，毫无进展了。</p> <p>这很重要：<strong> HTTP/2 下 WebSocket 的缺失，是因为根本没人写出来一份规范 </strong>（及其实现）。这些事情不会自己发生，它们需要一群相信这份事业并为之努力工作的人。</p> <p>HTTP/2 下 WebSocket 当然有好处，它只是连接上的一个数据流，这个连接同时也能服务于其他的非 WebSocket 的通信。而 HTTP/1 连接升级的 WebSocket 独占了整个连接。</p> <h2 id="-">替代方案</h2> <p>所以 HTTP/2 下面我们拿什么来替代 WebSocket 呢？好吧，也有几个选择。可能的情况是，你要么坚持着 HTTP/2， 从 HTTP/1 升级，使用 Web 推送(Web push)，要么就走到 WebRTC 这条路上来。</p> <p>如果你真的必须要坚持使用 WebSocket， 那很简单，你只需要像之前一样，从 HTTP/1 连接升级到 WebSocket。和我交谈过的大部分非常坚持 WebSocket的人都是那些开发者，他们就只需要很基本的单一的连接，所以 HTTP/1 和 HTTP/2 对他们来说没什么差别。</p> <p>如果真的非常坚持使用 HTTP/2，你可以像过去使用 <a href="https://tools.ietf.org/html/rfc6202" target="_blank">长轮询</a>那样，那会儿 WebSocket 还没被发明出来。这曾经是挺糟糕的方案，因为会浪费一个连接，而且有一个大部分时间是空闲着的连接也容易导致错误。在 HTTP/2 下面这样做，问题就少了很多，因为它只是一个不会被使用得太多的单向流，所以不会造成太多浪费。此外，连接很可能为其他数据流使用，这能减少空闲连接被 NATs 或防火墙干掉的问题。</p> <p><a href="https://www.w3.org/TR/push-api/" target="_blank">Web Push API</a> 是 W3C 2015年带来的一个和 WebSocket 这样人工化的、“粗糙”的方式相比， 更有 Web 范儿的（more “webby”）推送方式。如果你主要是拿 WebSocket 来推送消息通知，这可能是更方便的选择。</p> <p>WebSocket 之后引入的是 <a href="http://w3c.github.io/webrtc-pc/" target="_blank">WebRTC</a>。这是用来解决浏览器之间通信的，不过拿过来做 WebSocket 曾被拿来做过的一些事情肯定也是一种选择。</p> <h2 id="-">未来</h2> <p>HTTP/2 下的 WebSocket <em>可能</em> 还是会被实现。它没被完成的实际情况，只能表明人们还没有足够的兴趣。</p> <h2 id="non-tls">Non-TLS</h2> <p>想一想，浏览器只能在 <a href="https://daniel.haxx.se/blog/2015/03/06/tls-in-http2/" target="_blank">TLS 之上使用 HTTP/2</a>，而 WebSocket 只需通过普通的 TCP 连接就能完成。实际上，将 HTTP 连接提升到 WebSocket 的唯一途径就是使用 HTTP/1 中 <code>Upgrade:</code>响应头的小把戏，而不是 HTTP/2 为了减少需要的往返数量而使用的用于 TSL 的应用层协议(ALPN)的办法(<a href="https://en.wikipedia.org/wiki/Application-Layer_Protocol_Negotiation" target="_blank">ALPN method for TLS</a>)。</p> <p>如果真有人要把 WebSocket 引入到 HTTP/2 中，他们很可能只能通过浏览器内部使用 TLS 来实现。</p></div></article> <nav class="pagination"><a href="/post/queues-in-node.js" title="[译] Node.js 中的队列" class="prev">« [译] Node.js 中的队列</a> <a href="/post/app-with-react-native" title="react-native 开发 App 手记" class="next">react-native 开发 App 手记 »</a></nav></div> <footer id="footer" class="inner">
      © 2022 -  文蔺的博客
      
        <span> - </span> <a href="/" class="nuxt-link-active">www.wemlion.com</a> <br>
      Powered by <a target="_blank" href="https://nuxtjs.org">Nuxt.js</a> & <a target="_blank" rel="nofollow" href="https://firekylin.org" class="external">FireKylin</a></footer></div></div></div></div><script>window.__NUXT__={layout:"default",data:[{}],error:null,serverRendered:!0}</script><script src="/static/c418fb652629ac1ad5ca.js" defer></script><script src="/static/0039fa4a5e03e32a9c78.js" defer></script><script src="/static/a04af2434d342797c405.js" defer></script><script src="/static/a9e13b4b84fcd888d410.js" defer></script><script src="/static/0329710550037b626a84.js" defer></script>
  </body>
</html>
