<!doctype html>
<html data-n-head-ssr data-n-head="">
  <head>
    <title data-n-head="true">[译] 给 Service Worker 开后门 | 文蔺的博客</title><meta data-n-head="true" charset="utf-8"><meta data-n-head="true" name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta data-n-head="true" name="description" content="文蔺的前端学习记录，国外技术文章翻译，个人学习心得等等这些都会记录在这里。"><meta data-n-head="true" name="keywords" content="翻译,Service Worker"><meta data-n-head="true" name="description" content="给 Service Worker 开后门"><link data-n-head="true" rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/static/0501d49c081ea86e209e.css">
  </head>
  <body data-n-head="">
    <div data-server-rendered="true" id="__nuxt"><!----><div id="__layout"><div class="wrapper"><nav id="sidebar" class="behavior_1"><div class="wrap"><div class="profile"><a href="/" class="nuxt-link-active"><img src="/imgs/avatar.jpg" alt="文蔺的博客"></a> <span>文蔺的博客</span></div> <ul class="buttons"><li><a href="/" title="主页" class="nuxt-link-active"><i class="iconfont icon-home"></i> <span> 主页</span></a></li><li><a href="/archives" title="归档"><i class="iconfont icon-archive"></i> <span> 归档</span></a></li><li><a href="/slides" title="Slides"><i class="iconfont icon-archive"></i> <span> Slides</span></a></li><li><a href="/about" title="关于"><i class="iconfont icon-user"></i> <span> 关于</span></a></li><li><a href="/link" title="关注"><i class="iconfont icon-link"></i> <span> 关注</span></a></li><li><a href="/collection" title="收藏"><i class="iconfont icon-archive"></i> <span> 收藏</span></a></li></ul></div> <ul class="buttons"><li><a href="https://github.com/AngusFu/" rel="nofollow" target="_blank" class="inline"><i title="GitHub" class="iconfont icon-github-v"></i></a> <!----> <!----> <a href="/atom.xml" target="_blank" class="inline"><i title="RSS" class="iconfont icon-rss-v"></i></a> <a href="/search" class="inline"><i title="Search" class="iconfont icon-search"></i></a></li></ul></nav> <div id="header"><div class="btn-bar"><i></i></div> <h1><a href="/" class="nuxt-link-active">文蔺的博客</a></h1> <a href="/about/" class="me"><img src="/imgs/avatar.jpg" alt="文蔺的博客"></a></div> <div id="sidebar-mask" style="display:none"></div> <div id="main" class="main"><div id="page-post"><article class="post detail"><div class="meta"><div class="date">2016-07-13</div></div> <h1 class="title">[译] 给 Service Worker 开后门</h1> <div class="entry-content"><blockquote><p style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">
          原文作者:
          <a target="_blank" href="https://medium.com/@adactio/">@Jeremy Keith</a> <br>原文地址:
          <a target="_blank" href="https://medium.com/@adactio/backdoor-service-workers-86d241d79996#.bfuq4cdih">https://medium.com/@adactio/backdoor-service-workers-86d241d79996#.bfuq4cdih</a> <br>译文地址:
          <a target="_blank" href="http://www.wemlion.com/post/backdoor-service-worker">http://www.wemlion.com/post/backdoor-service-worker</a> <br>本文由
          <a target="_blank" href="http://www.wemlion.com">文蔺</a> 翻译，转载请保留此声明。
          <br>著作权属于原作者，本译文仅用于学习、研究和交流目的，请勿用于商业目的。
        </p></blockquote> <p>在<a href="https://adactio.com/journal/10866" target="_blank">渐进式 Web App 开发峰会(Progressive Web App dev Summit)</a>上展示的时候，我花了<a href="https://youtu.be/EyyEfxrk_NU?t=21m4s" target="_blank">差不多 20 分钟</a>讲了这样一点：</p> <blockquote><p><a href="https://infrequently.org/" target="_blank">Alex</a>，你昨天演讲展示了华盛顿邮报(Washington Post)的 <a href="https://www.ampproject.org/" target="_blank">AMP</a> （——译者注：Accelerated Mobile Pages Project） demo。轻轻那么一点，华盛顿邮报的 AMP 应用就出来了，还能够通过<a href="https://www.ampproject.org/docs/reference/extended/amp-install-serviceworker.html" target="_blank">自定义元素</a>安装 Service Worker。可是我去看浏览器地址栏的时候……并不是华盛顿邮报。只是 AMP 的 CDN 而已。所以我和 AMP 团队的 <a href="https://paulbakaus.com/" target="_blank">Paul Backaus</a> 聊了聊，他解释说那是一个 iframe，使用 iframe 能安装其他地方的 Service Worker。</p></blockquote> <p>Alex 和 <a href="https://twitter.com/emschec" target="_blank">Emily</a> 解释说，嗯，这就是 iframe 的工作方式。当你仔细想想，其实还是挺有意义的，毕竟一个 iframe 和任何其他的浏览器窗口没什么不一样的。尽管如此，这还是会让人觉得有点违反<a href="https://en.wikipedia.org/wiki/Principle_of_least_astonishment" target="_blank">最小惊奇原则</a>。</p> <p>让我们假设，你遵循了我这并不当真的建议，去<a href="https://adactio.com/journal/10800" target="_blank">创建一个渐进式的 Web 应用商店</a>，其首页可能有最新的十到二十个渐进式 Web App。你也可以同样地使用十到二十个 iframe，以便给浏览页面的用户“预安装”( pre-install )这些网站。</p> <p>理论扯够了。现在来点实际操作……</p> <p>假设你从未访问过我写的书的网站，<a href="https://html5forwebdesigners.com/" target="_blank">html5forwebdesigners.com</a>(如果你访问过，又还想跟着我把实验进行下去，那么你得打开浏览器设置然后删除这个域下面存的所有东西)。</p> <p>也许你曾不经意间访问过我的个人网站<a href="https://adactio.com/" target="_blank">adactio.com</a>。主页下面有个小广告，上面写着“Read my book”，链接指向<a href="https://html5forwebdesigners.com/" target="_blank">html5forwebdesigners.com</a>。我在链接后面加了这样两行标记：</p> <pre><code class="hljs lang-html"><span class="hljs-tag">&lt;<span class="hljs-name">iframe</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://html5forwebdesigners.com/iframe.html"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"width: 0; height: 0; border: 0"</span>></span>
<span class="hljs-tag">&lt;/<span class="hljs-name">iframe</span>></span></code></pre><p>该隐藏的 iframe 会拉取<a href="https://html5forwebdesigners.com/iframe.html" target="_blank">带有一个 script 元素的空页面</a>。</p> <pre><code class="hljs lang-html"><span class="hljs-meta">&lt;!DOCTYPE html></span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>></span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>></span>
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"utf-8"</span>></span>
<span class="hljs-tag">&lt;<span class="hljs-name">title</span>></span>HTML5 For Web Designers<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>></span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>></span><span class="actionscript">
<span class="hljs-keyword">if</span> (<span class="hljs-string">'serviceWorker'</span> <span class="hljs-keyword">in</span> navigator) {
  navigator.serviceWorker.register(<span class="hljs-string">'/serviceworker.js'</span>);
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>></span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>></span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>></span></code></pre><p>这样就注册了我的<a href="https://html5forwebdesigners.com/serviceworker.js" target="_blank">书籍网站的 Service Worker</a>，然后就开始下载所有<a href="https://adactio.com/journal/10754" target="_blank">离线渲染整个网站</a>所需的资源。</p> <p>搞定了。从未访问过 html5forwebdesigners.com 这个域名，但网站已经在你的设备上预加载过了，一切仅仅因为你访问过 adactio.com。</p> <p>一些注意事项：</p> <p>我不得不降低 html5forwebdesigners.com 的内容安全策略（Content Security Policy），以允许能通过 iframe 将其嵌入 adactio.com:</p> <blockquote><p>Header always set Access-Control-Allow-Origin: “<a href="https://adactio.com" target="_blank">https://adactio.com</a>"</p></blockquote> <p>若你的浏览器设置选择了“禁止第三方 cookie 及 网站数据”（“Block third-party cookies and site data”），通过 iframe 调用的 Service Worker 是不会被安装的：</p> <blockquote><p>Uncaught (in promise) DOMException: Failed to register a ServiceWorker: The user denied permission to use Service Worker.</p></blockquote> <p>我在本文中的示例相对来说是无害的。不过，可以难想象一些更加极端的情形。想象有一家出版商，有 50 种出版物，每本书有一个网站。每个网站都可能有一个空页面，等待着通过 iframe 被其他 49 个网站嵌入。你只需要访问其中一个页面，就会有 50 个Service Workers 在后台运转起来缓存资源。</p> <p>这就有了<a href="https://en.wikipedia.org/wiki/Tragedy_of_the_commons" target="_blank">“公地悲剧”</a>的潜在可能。希望我们能清楚的知道，如何去使用这力量。</p> <p>千万别让广告狗们知道哦！（直译：千万别给广告行业知道这。）</p></div></article> <nav class="pagination"><a href="/post/hybrid-or-native-mobile-app-use-the-right-tool-for-the-job" title="[译] Hybrid or Native： 适合工作的才是最好的" class="prev">« [译] Hybrid or Native： 适合工作的才是最好的</a> <a href="/post/Node.js-sh-scripts-Manager" title="Node.js .sh scripts Manager" class="next">Node.js .sh scripts Manager »</a></nav></div> <footer id="footer" class="inner">
      © 2022 -  文蔺的博客
      
        <span> - </span> <a href="/" class="nuxt-link-active">www.wemlion.com</a> <br>
      Powered by <a target="_blank" href="https://nuxtjs.org">Nuxt.js</a> & <a target="_blank" rel="nofollow" href="https://firekylin.org" class="external">FireKylin</a></footer></div></div></div></div><script>window.__NUXT__={layout:"default",data:[{}],error:null,serverRendered:!0}</script><script src="/static/c418fb652629ac1ad5ca.js" defer></script><script src="/static/59557c23c1cb3955fd08.js" defer></script><script src="/static/a04af2434d342797c405.js" defer></script><script src="/static/a9e13b4b84fcd888d410.js" defer></script><script src="/static/0329710550037b626a84.js" defer></script>
  </body>
</html>
